buildscript {
  repositories {
    jcenter()
  }
  dependencies {
    classpath 'org.hidetake:gradle-ssh-plugin:2.2.0'
  }
}

repositories {
  mavenCentral()
}

apply plugin: 'java'
apply plugin: 'application'
apply plugin: 'org.hidetake.ssh'

dependencies {
  compile 'au.com.codeka:carrot:2.2.0'
  compile 'joda-time:joda-time:2.3'
  compile 'com.google.api-client:google-api-client:1.19.1'
  compile 'com.google.api-client:google-api-client-gson:1.19.1'
  compile 'com.google.code.findbugs:jsr305:3.0.0'
  compile 'com.google.code.gson:gson:2.7'
  compile 'com.google.firebase:firebase-admin:4.1.1'
  compile 'com.google.guava:guava:20.0'
  compile 'com.squareup.wire:wire-gson-support:2.1.2'
  compile 'org.eclipse.jetty:jetty-server:9.4.0.v20161208'
  compile 'org.eclipse.jetty.websocket:websocket-server:9.4.0.v20161208'
  compile 'org.xerial:sqlite-jdbc:3.16.1'
  compile project(':common')
  compile project(':planet-render')
}

task dataFiles {
  // want to include more than just a single directory
  FileTree data = fileTree(dir: "src/main/data/")
  data.exclude "store/*"
  data.exclude "cache/*"
  outputs.dir data
}

applicationDistribution.from(dataFiles) {
  into "data"
}

mainClassName = "au.com.codeka.warworlds.server.Program"

ssh.settings {
  knownHosts = file('../../known_hosts')
}

remotes {
  prod {
    host = 'wwmmo.codeka.com.au'
    user = 'wwmmo'
    identity = file('../../wwmmo2.id_rsa')
  }
}

task deploy(type: Exec, dependsOn: 'installDist') {
  workingDir "${buildDir}/install/server"
  commandLine "sh", "-c", "rsync -a -e" +
      " 'ssh -o UserKnownHostsFile=${projectDir}/../../known_hosts -i ${projectDir}/../../wwmmo2.id_rsa'" +
      " . wwmmo@wwmmo.codeka.com.au:/home/wwmmo/staging"
}
